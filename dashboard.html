<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Cruz Verde ‚Äî Dashboard de Visitas</title><link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet"><style>:root{--bg:#f4f8f4;--surface:#ffffff;--surface2:#e8f5e8;--border:#c2ddc2;--accent:#2e8b2e;--accent2:#1a6e1a;--text:#1c1a17;--text-muted:#7a7265;--danger:#c0392b;--danger-bg:#fde8e8;--warning:#d4a000;--warn-bg:#fff8d6;--ok:#145214;--ok-bg:#d4edda;--shadow:0 2px 12px rgba(0,0,0,0.07)}*{box-sizing:border-box;margin:0;padding:0}body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh}header{background:linear-gradient(135deg,#1a6e1a 0%,#2e8b2e 100%);padding:18px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,0.2)}.h-left{display:flex;align-items:center;gap:14px}.logo{background:var(--accent);width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:17px;color:#fff;flex-shrink:0}.h-title{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:700;color:#fff}.h-sub{font-size:0.72rem;color:rgba(255,255,255,0.55);margin-top:1px}.h-actions{display:flex;gap:10px;align-items:center}.btn-h{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:500;padding:8px 15px;text-decoration:none;display:flex;align-items:center;gap:5px;transition:background 0.2s;white-space:nowrap}.btn-h:hover{background:rgba(255,255,255,0.18)}.btn-h.primary{background:#f5c800;border-color:#f5c800;color:#1a6e1a;font-weight:700}.btn-h.primary:hover{background:#e6b800}.wrap{max-width:1100px;margin:0 auto;padding:28px 20px 60px}.alert-banner{background:linear-gradient(135deg,var(--danger-bg),#ffe4e1);border:1.5px solid #fca5a5;border-radius:12px;padding:16px 20px;margin-bottom:24px;display:flex;align-items:flex-start;gap:12px;animation:pulse-border 2s ease infinite}@keyframes pulse-border{0%,100%{border-color:#fca5a5}50%{border-color:var(--danger)}}.alert-banner.hidden{display:none}.alert-icon{font-size:1.5rem;flex-shrink:0}.alert-content h3{font-family:'Syne',sans-serif;font-size:0.92rem;font-weight:800;color:var(--danger);margin-bottom:4px}.alert-items{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}.alert-chip{background:var(--danger);color:#fff;font-size:0.75rem;font-weight:600;padding:3px 10px;border-radius:20px}.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:var(--shadow);transition:transform 0.2s}.stat-card:hover{transform:translateY(-2px)}.stat-label{font-size:0.73rem;font-weight:500;text-transform:uppercase;letter-spacing:0.6px;color:var(--text-muted);margin-bottom:8px}.stat-val{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;color:var(--text);line-height:1}.stat-sub{font-size:0.78rem;color:var(--text-muted);margin-top:6px}.stat-card.danger .stat-val{color:var(--danger)}.stat-card.warn .stat-val{color:var(--warning)}.stat-card.ok .stat-val{color:#2e8b2e}.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}.section-head h2{font-family:'Syne',sans-serif;font-size:1rem;font-weight:800;color:var(--text)}.section-head .badge{background:var(--surface2);border:1px solid var(--border);border-radius:20px;font-size:0.75rem;font-weight:600;padding:3px 12px;color:var(--text-muted)}.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;align-items:center}.filter-input{background:var(--surface);border:1.5px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.85rem;padding:8px 12px;outline:none;transition:border-color 0.2s}.filter-input:focus{border-color:var(--accent2)}.filter-input::placeholder{color:var(--text-muted)}.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow);margin-bottom:28px}table{width:100%;border-collapse:collapse;font-size:0.85rem}thead{background:var(--surface2)}th{padding:12px 14px;text-align:left;font-family:'Syne',sans-serif;font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);white-space:nowrap;border-bottom:1px solid var(--border)}td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:middle}tr:last-child td{border-bottom:none}tr:hover td{background:#fafaf7}.badge-crit{display:inline-flex;align-items:center;gap:4px;font-size:0.75rem;font-weight:600;padding:3px 10px;border-radius:20px}.badge-alta{background:var(--danger-bg);color:var(--danger)}.badge-media{background:var(--warn-bg);color:var(--warning)}.badge-baja{background:var(--ok-bg);color:var(--ok)}.badge-estado{display:inline-block;font-size:0.73rem;font-weight:600;padding:3px 10px;border-radius:20px}.estado-pendiente{background:var(--warn-bg);color:var(--warning)}.estado-proceso{background:#dbeafe;color:#1d4ed8}.estado-resuelto{background:var(--ok-bg);color:var(--ok)}.fecha-vence{font-size:0.78rem;font-weight:600}.fecha-vence.vencida{color:var(--danger)}.fecha-vence.hoy{color:var(--warning)}.fecha-vence.pronto{color:#9333ea}.fecha-vence.ok{color:var(--ok)}.cal-stars{font-size:0.82rem}.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:500;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;overflow-y:auto;backdrop-filter:blur(4px)}.modal-bg.hidden{display:none}.modal{background:var(--surface);border-radius:16px;width:100%;max-width:680px;box-shadow:0 20px 60px rgba(0,0,0,0.25);overflow:hidden}.modal-header{background:linear-gradient(135deg,#1a6e1a,#2e8b2e);padding:20px 24px;display:flex;align-items:center;justify-content:space-between}.modal-header h2{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;color:#fff}.modal-close{background:rgba(255,255,255,0.1);border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:1rem;padding:4px 10px}.modal-body{padding:24px;display:flex;flex-direction:column;gap:20px}.modal-section h3{font-family:'Syne',sans-serif;font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:6px}.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}.modal-field label{font-size:0.72rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);display:block;margin-bottom:2px}.modal-field p{font-size:0.88rem;color:var(--text);font-weight:500}.inc-detail{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}.inc-detail:last-child{margin-bottom:0}.inc-detail-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.inc-detail-head strong{font-family:'Syne',sans-serif;font-size:0.82rem;color:var(--text)}.empty{text-align:center;padding:60px 20px}.empty .empty-icon{font-size:3rem;margin-bottom:12px}.empty h3{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;color:var(--text);margin-bottom:6px}.empty p{font-size:0.88rem;color:var(--text-muted)}.city-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:28px}.city-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:var(--shadow)}.city-name{font-family:'Syne',sans-serif;font-size:0.95rem;font-weight:800;color:var(--text);margin-bottom:8px}.city-stat{display:flex;justify-content:space-between;font-size:0.8rem;color:var(--text-muted);margin-top:4px}.city-stat strong{color:var(--text)}.city-bar{height:4px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden}.city-bar-fill{height:100%;background:#2e8b2e;border-radius:2px;transition:width 0.6s}.toast{position:fixed;bottom:24px;right:24px;background:#1a6e1a;color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:0.85rem;padding:13px 20px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.2);transform:translateY(80px);opacity:0;transition:all 0.35s cubic-bezier(.22,1,.36,1);z-index:999}.toast.show{transform:translateY(0);opacity:1}.btn-pdf{background:#2e8b2e;border:none;border-radius:8px;color:#fff;cursor:pointer;font-family:'Syne',sans-serif;font-size:0.82rem;font-weight:700;padding:8px 16px;display:flex;align-items:center;gap:5px;transition:opacity 0.2s}.btn-pdf:hover{opacity:0.85}@media print{header,.h-actions,.filters,.btn-pdf,.btn-del-inc,.modal-close{display:none !important}.wrap{padding:0}.table-wrap{box-shadow:none}}@media (max-width:700px){.stats-row{grid-template-columns:1fr 1fr}.city-grid{grid-template-columns:1fr 1fr}.modal-grid{grid-template-columns:1fr}header{flex-wrap:wrap;gap:10px}}</style></head><body><div style="background:#f5c800;height:5px;width:100%;position:sticky;top:0;z-index:101;"></div><header style="top:5px;"><div class="h-left"><img src="data:image/jpeg;base64,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" alt="Cruz Verde" style="height:40px;width:auto;border-radius:6px;background:#fff;padding:2px;"><div><div class="h-title">Dashboard de Seguimiento ‚Äî Cruz Verde</div><div class="h-sub">Sistema de Visitas a Locales &nbsp;¬∑&nbsp; <span id="lastUpdated">‚Äî</span></div></div></div><div class="h-actions"><button class="btn-h" onclick="loadData()" title="Actualizar datos de SharePoint">üîÑ Actualizar</button><button class="btn-h" onclick="exportCSV()">‚¨á Exportar CSV</button><button class="btn-h" onclick="window.print()">üñ® Imprimir</button><a href="formulario_visita.html" class="btn-h primary">Ôºã Nueva Visita</a></div></header><div class="wrap"><div id="loadingBanner" style="display:none;align-items:center;justify-content:center;gap:12px;background:#e8f5e8;border:1.5px solid #c2ddc2;border-radius:12px;padding:18px 24px;margin-bottom:20px;"><div style="width:22px;height:22px;border:3px solid #c2ddc2;border-top-color:#2e8b2e;border-radius:50%;animation:spin 0.8s linear infinite;flex-shrink:0;"></div><span style="font-family:'Syne',sans-serif;font-weight:700;font-size:0.9rem;color:#1a6e1a;">Cargando datos desde SharePoint...</span></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style><div class="alert-banner hidden" id="alertBanner"><div class="alert-icon">üîî</div><div class="alert-content"><h3 id="alertTitle">Incidencias con fecha l√≠mite pr√≥xima o vencida</h3><div class="alert-items" id="alertItems"></div></div></div><div class="stats-row"><div class="stat-card"><div class="stat-label">Total Visitas</div><div class="stat-val" id="statVisitas">0</div><div class="stat-sub">registradas</div></div><div class="stat-card danger"><div class="stat-label">Incidencias Altas</div><div class="stat-val" id="statAltas">0</div><div class="stat-sub">criticidad alta</div></div><div class="stat-card warn"><div class="stat-label">Pendientes</div><div class="stat-val" id="statPendientes">0</div><div class="stat-sub">sin resolver</div></div><div class="stat-card ok"><div class="stat-label">Vencen esta semana</div><div class="stat-val" id="statVencen">0</div><div class="stat-sub">pr√≥ximos 7 d√≠as</div></div></div><div class="section-head"><h2>üó∫ Resumen por Ciudad</h2></div><div class="city-grid" id="cityGrid"><div style="grid-column:1/-1;text-align:center;color:var(--text-muted);font-size:0.85rem;padding:20px;">Sin datos a√∫n</div></div><div class="section-head"><h2>‚ö† Incidencias y Seguimiento</h2><div class="badge" id="incBadge">0 incidencias</div></div><div class="filters"><input type="text" class="filter-input" id="filterLocal" placeholder="üîç Buscar por local..." oninput="renderIncidents()"><select class="filter-input" id="filterCrit" onchange="renderIncidents()"><option value="">Todas las criticidades</option><option value="Alta">üî¥ Alta</option><option value="Media">üü° Media</option><option value="Baja">üü¢ Baja</option></select><select class="filter-input" id="filterEstado" onchange="renderIncidents()"><option value="">Todos los estados</option><option value="Pendiente">Pendiente</option><option value="En proceso">En proceso</option><option value="Resuelto">Resuelto</option></select><select class="filter-input" id="filterCiudad" onchange="renderIncidents()"><option value="">Todas las ciudades</option></select></div><div class="table-wrap" id="incidenciasTable"><div class="empty"><div class="empty-icon">üìã</div><h3>Sin incidencias a√∫n</h3><p>Cuando registres visitas desde el formulario, las incidencias aparecer√°n aqu√≠ autom√°ticamente</p></div></div><div class="section-head" style="margin-top:8px;"><h2>üìÅ Historial de Visitas</h2><div class="badge" id="visitasBadge">0 visitas</div></div><div class="filters"><input type="text" class="filter-input" id="filterVisita" placeholder="üîç Buscar visita..." oninput="renderVisitas()"><select class="filter-input" id="filterCiudadV" onchange="renderVisitas()"><option value="">Todas las ciudades</option></select></div><div class="table-wrap" id="visitasTable"><div class="empty"><div class="empty-icon">üè™</div><h3>Sin visitas a√∫n</h3><p>Las visitas registradas desde el formulario aparecer√°n aqu√≠</p></div></div></div><div class="modal-bg hidden" id="detailModal"><div class="modal"><div class="modal-header"><h2 id="modalTitle">Detalle de Visita</h2><button class="modal-close" onclick="closeModal()">‚úï</button></div><div class="modal-body" id="modalBody"></div></div></div><div class="toast" id="toast"></div><script>const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwTDaRZIQLST72kYHEoQvwiHclL3L_lGDbzUZH3YGBwSjxP3l7fZw81CMABHlQBaR6K/exec';

async function loadData() {
const banner = document.getElementById('loadingBanner');
if (banner) banner.style.display = 'flex';
try {
const [vr, ir] = await Promise.all([
fetch(SCRIPT_URL + '?data=' + encodeURIComponent(JSON.stringify({type:'visitas'}))),
fetch(SCRIPT_URL + '?data=' + encodeURIComponent(JSON.stringify({type:'incidencias'})))
]);
const vj = await vr.json();
const ij = await ir.json();
const incRows = ij.data || [];
const incMap = {};
incRows.forEach(r => {
const vid = r[0];
if (!incMap[vid]) incMap[vid] = [];
incMap[vid].push({tipo:r[4],descripcion:r[5],criticidad:r[6],responsable:r[7],area:r[8],fecha_seguimiento:r[9],estado:r[10]});
});
allVisits = (vj.data || []).map(r => ({
id:r[0],timestamp:r[1],auditor:r[2],codigo:r[3],nombre:r[4],
ciudad:r[5],lider:r[6],fecha_visita:r[7],hora_visita:r[8],
sala_piso:r[9],sala_limpieza:r[10],sala_exhibicion:r[11],sala_pop:r[12],sala_obs:r[13],
bod_org:r[14],bod_inv:r[15],bod_cond:r[16],bod_seg:r[17],bod_obs:r[18],
com_metas:r[19],com_flujo:r[20],com_servicio:r[21],com_estrategias:r[22],com_obs:r[23],
gen_infra:r[24],gen_personal:r[25],gen_protocolos:r[26],gen_calificacion:r[27],gen_obs:r[28],
compromisos:r[29],proxima_visita:r[30],firma:r[31],
num_incidencias:r[32],incidencias_alta:r[33],
incidencias:incMap[r[0]]||[]
})));
renderDashboard(allVisits);
} catch(err) {
console.error(err);
allVisits = JSON.parse(localStorage.getItem('vl_visits') || '[]');
renderDashboard(allVisits);
} finally {
if (banner) banner.style.display = 'none';
const ts = document.getElementById('lastUpdated');
if (ts) ts.textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-CO');
}
}
function showLoading(show) {
const el = document.getElementById('loadingBanner');
if (el) el.style.display = show ? 'flex' : 'none';
}
function injectDemo() {
const today = new Date();
const fmt = (d) => d.toISOString().split('T')[0];
const addDays = (n) => { const d = new Date(); d.setDate(d.getDate() + n); return fmt(d); };
visits = [
{
id: '1', timestamp: new Date().toISOString(),
auditor: 'Mar√≠a Gonz√°lez', codigo: 'LOC-001', nombre: 'Centro Comercial Norte',
ciudad: 'Bogot√°', lider: 'Carlos Ruiz', fecha_visita: fmt(today), hora_visita: '09:30',
sala_piso: 'Bueno', sala_limpieza: 'Regular', sala_exhibicion: 'Bueno', sala_pop: 'Correcto',
sala_obs: 'Faltan precios en algunos productos',
bod_org: 'Bueno', bod_inv: 'Al d√≠a', bod_cond: '√ìptimas', bod_seg: 'Controlado', bod_obs: '',
com_metas: 'En meta (90-100%)', com_flujo: 'Normal', com_servicio: 'Bueno', com_estrategias: 'Promo mayo', com_obs: '',
gen_infra: 'Bueno', gen_personal: 'Completa', gen_protocolos: 'Total', gen_calificacion: '‚≠ê‚≠ê‚≠ê‚≠ê Muy Bueno', gen_obs: 'Local en buen estado general',
compromisos: 'Actualizar precios antes del viernes', proxima_visita: addDays(30), firma: 'Mar√≠a Gonz√°lez',
num_incidencias: 2, incidencias_alta: 1,
incidencias: [
{ tipo: 'Operativa', descripcion: 'Caja 2 no imprime tickets correctamente', criticidad: 'Alta', responsable: 'Pedro L√≥pez', area: 'TI', fecha_seguimiento: addDays(3), estado: 'Pendiente' },
{ tipo: 'Inventario', descripcion: 'Discrepancia de 5 unidades en producto X', criticidad: 'Media', responsable: 'Ana Torres', area: 'Log√≠stica', fecha_seguimiento: addDays(7), estado: 'En proceso' }
]
},
{
id: '2', timestamp: new Date(Date.now() - 86400000 * 3).toISOString(),
auditor: 'Mar√≠a Gonz√°lez', codigo: 'LOC-002', nombre: 'Plaza del Sur',
ciudad: 'Medell√≠n', lider: 'Laura G√≥mez', fecha_visita: addDays(-3), hora_visita: '14:00',
sala_piso: 'Excelente', sala_limpieza: 'Excelente', sala_exhibicion: 'Excelente', sala_pop: 'Correcto', sala_obs: '',
bod_org: 'Regular', bod_inv: 'Con retrasos', bod_cond: 'Aceptables', bod_seg: 'Parcial', bod_obs: 'Falta se√±alizaci√≥n en pasillos',
com_metas: 'Superado (+100%)', com_flujo: 'Alto', com_servicio: 'Excelente', com_estrategias: 'D√≠a sin IVA', com_obs: '',
gen_infra: 'Excelente', gen_personal: 'Completa', gen_protocolos: 'Total', gen_calificacion: '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente', gen_obs: '',
compromisos: 'Mejorar se√±alizaci√≥n de bodega', proxima_visita: addDays(25), firma: 'Mar√≠a Gonz√°lez',
num_incidencias: 1, incidencias_alta: 0,
incidencias: [
{ tipo: 'Infraestructura', descripcion: 'Luz fundida en bodega trasera', criticidad: 'Baja', responsable: 'Mantenimiento', area: 'Operaciones', fecha_seguimiento: addDays(-1), estado: 'Pendiente' }
]
},
{
id: '3', timestamp: new Date(Date.now() - 86400000 * 7).toISOString(),
auditor: 'Mar√≠a Gonz√°lez', codigo: 'LOC-003', nombre: 'Megacentro Cali',
ciudad: 'Cali', lider: 'Jorge Herrera', fecha_visita: addDays(-7), hora_visita: '10:00',
sala_piso: 'Regular', sala_limpieza: 'Deficiente', sala_exhibicion: 'Regular', sala_pop: 'Incompleto', sala_obs: 'Requiere limpieza profunda urgente',
bod_org: 'Deficiente', bod_inv: 'Sin control', bod_cond: 'Deficientes', bod_seg: 'Sin control', bod_obs: 'Bodega completamente desorganizada',
com_metas: 'Muy bajo (-70%)', com_flujo: 'Bajo', com_servicio: 'Regular', com_estrategias: '', com_obs: 'Ventas muy por debajo de la meta',
gen_infra: 'Requiere intervenci√≥n', gen_personal: 'Incompleta', gen_protocolos: 'Incumplimiento', gen_calificacion: '‚≠ê Deficiente', gen_obs: 'Local requiere intervenci√≥n urgente',
compromisos: 'Plan de mejora en 15 d√≠as', proxima_visita: addDays(14), firma: 'Mar√≠a Gonz√°lez',
num_incidencias: 3, incidencias_alta: 2,
incidencias: [
{ tipo: 'Personal', descripcion: '3 colaboradores sin capacitaci√≥n actualizada', criticidad: 'Alta', responsable: 'RRHH Central', area: 'RRHH', fecha_seguimiento: addDays(1), estado: 'Pendiente' },
{ tipo: 'Operativa', descripcion: 'Sistema POS desactualizado ‚Äî falla en ventas', criticidad: 'Alta', responsable: 'Pedro L√≥pez', area: 'TI', fecha_seguimiento: addDays(0), estado: 'Pendiente' },
{ tipo: 'Infraestructura', descripcion: 'Goteras en techo de bodega', criticidad: 'Media', responsable: 'Mantenimiento', area: 'Operaciones', fecha_seguimiento: addDays(5), estado: 'En proceso' }
]
}
];
localStorage.setItem('vl_visits', JSON.stringify(visits));
}
function render() {
computeStats();
renderCityGrid();
renderIncidents();
renderVisitas();
checkAlerts();
populateCityFilters();
const lu = document.getElementById('lastUpdated');
if (lu) lu.textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-CO', {hour:'2-digit',minute:'2-digit'});
}
function computeStats() {
let altas = 0, pendientes = 0, vencen = 0;
const now = new Date(); now.setHours(0,0,0,0);
const week = new Date(now); week.setDate(week.getDate() + 7);
visits.forEach(v => {
(v.incidencias || []).forEach(inc => {
if (inc.criticidad === 'Alta') altas++;
if (inc.estado !== 'Resuelto') pendientes++;
if (inc.fecha_seguimiento && inc.estado !== 'Resuelto') {
const fd = new Date(inc.fecha_seguimiento + 'T00:00:00');
if (fd <= week) vencen++;
}
});
});
document.getElementById('statVisitas').textContent = visits.length;
document.getElementById('statAltas').textContent = altas;
document.getElementById('statPendientes').textContent = pendientes;
document.getElementById('statVencen').textContent = vencen;
}
function checkAlerts() {
const now = new Date(); now.setHours(0,0,0,0);
const threeDays = new Date(now); threeDays.setDate(now.getDate() + 3);
const alerts = [];
visits.forEach(v => {
(v.incidencias || []).forEach(inc => {
if (inc.estado === 'Resuelto' || !inc.fecha_seguimiento) return;
const fd = new Date(inc.fecha_seguimiento + 'T00:00:00');
if (fd <= threeDays) {
const diff = Math.round((fd - now) / 86400000);
let label = diff < 0 ? `${v.nombre}: VENCIDA (${inc.tipo})` : diff === 0 ? `${v.nombre}: VENCE HOY (${inc.tipo})` : `${v.nombre}: vence en ${diff}d (${inc.tipo})`;
alerts.push({ label, urgent: diff <= 0 });
}
});
});
const banner = document.getElementById('alertBanner');
if (alerts.length > 0) {
banner.classList.remove('hidden');
document.getElementById('alertTitle').textContent = `${alerts.length} incidencia(s) requieren atenci√≥n inmediata`;
const items = document.getElementById('alertItems');
items.innerHTML = '';
alerts.forEach(a => {
const chip = document.createElement('span');
chip.className = 'alert-chip';
chip.style.background = a.urgent ? 'var(--danger)' : '#9333ea';
chip.textContent = a.label;
items.appendChild(chip);
});
} else {
banner.classList.add('hidden');
}
}
function populateCityFilters() {
const cities = [...new Set(visits.map(v => v.ciudad).filter(Boolean))].sort();
['filterCiudad', 'filterCiudadV'].forEach(id => {
const sel = document.getElementById(id);
const cur = sel.value;
sel.innerHTML = '<option value="">Todas las ciudades</option>';
cities.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
sel.value = cur;
});
}
function renderCityGrid() {
const cityMap = {};
visits.forEach(v => {
if (!v.ciudad) return;
if (!cityMap[v.ciudad]) cityMap[v.ciudad] = { visitas: 0, incidencias: 0, altas: 0 };
cityMap[v.ciudad].visitas++;
cityMap[v.ciudad].incidencias += (v.incidencias || []).length;
cityMap[v.ciudad].altas += v.incidencias_alta || 0;
});
const grid = document.getElementById('cityGrid');
const cities = Object.entries(cityMap);
if (!cities.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--text-muted);font-size:0.85rem;padding:20px;">Sin datos</div>'; return; }
const maxV = Math.max(...cities.map(([,d]) => d.visitas));
grid.innerHTML = cities.map(([city, d]) => `
<div class="city-card"><div class="city-name">üìç ${city}</div><div class="city-stat"><span>Visitas</span><strong>${d.visitas}</strong></div><div class="city-stat"><span>Incidencias</span><strong>${d.incidencias}</strong></div><div class="city-stat"><span>Cr√≠ticas</span><strong style="color:${d.altas>0?'var(--danger)':'var(--ok)'}">${d.altas}</strong></div><div class="city-bar"><div class="city-bar-fill" style="width:${Math.round((d.visitas/maxV)*100)}%"></div></div></div>`).join('');
}
function renderIncidents() {
const filterLocal = document.getElementById('filterLocal').value.toLowerCase();
const filterCrit = document.getElementById('filterCrit').value;
const filterEstado = document.getElementById('filterEstado').value;
const filterCiudad = document.getElementById('filterCiudad').value;
const rows = [];
visits.forEach(v => {
if (filterCiudad && v.ciudad !== filterCiudad) return;
if (filterLocal && !v.nombre?.toLowerCase().includes(filterLocal) && !v.codigo?.toLowerCase().includes(filterLocal)) return;
(v.incidencias || []).forEach((inc, i) => {
if (filterCrit && inc.criticidad !== filterCrit) return;
if (filterEstado && inc.estado !== filterEstado) return;
rows.push({ v, inc, i });
});
});
document.getElementById('incBadge').textContent = rows.length + ' incidencias';
if (!rows.length) {
document.getElementById('incidenciasTable').innerHTML = `<div class="empty"><div class="empty-icon">‚úÖ</div><h3>Sin incidencias</h3><p>No hay incidencias con los filtros seleccionados</p></div>`;
return;
}
const now = new Date(); now.setHours(0,0,0,0);
const tbody = rows.map(({ v, inc }) => {
const crit = inc.criticidad?.toLowerCase() || '';
const estado = (inc.estado || 'Pendiente').toLowerCase().replace(' ', '-');
const estadoLabel = inc.estado || 'Pendiente';
let fechaHtml = '‚Äî';
if (inc.fecha_seguimiento) {
const fd = new Date(inc.fecha_seguimiento + 'T00:00:00');
const diff = Math.round((fd - now) / 86400000);
let cls = 'ok', label = fd.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' });
if (diff < 0) { cls = 'vencida'; label = `‚ö† Vencida (${Math.abs(diff)}d)`; }
else if (diff === 0) { cls = 'hoy'; label = 'üî• Vence hoy'; }
else if (diff <= 3) { cls = 'pronto'; label = `‚ö° En ${diff} d√≠as`; }
fechaHtml = `<span class="fecha-vence ${cls}">${label}</span>`;
}
return `<tr onclick="showVisitDetail('${v.id}')"><td><strong>${v.codigo}</strong><br><span style="font-size:0.78rem;color:var(--text-muted)">${v.nombre}</span></td><td style="font-size:0.78rem;color:var(--text-muted)">${v.ciudad}</td><td>${inc.tipo || '‚Äî'}</td><td style="max-width:200px;font-size:0.82rem">${inc.descripcion?.substring(0,60) || ''}${inc.descripcion?.length > 60 ? '...' : ''}</td><td><span class="badge-crit badge-${crit}">${inc.criticidad || '‚Äî'}</span></td><td style="font-size:0.82rem">${inc.responsable || '‚Äî'}</td><td>${fechaHtml}</td><td><span class="badge-estado estado-${estado}">${estadoLabel}</span></td></tr>`;
}).join('');
document.getElementById('incidenciasTable').innerHTML = `
<table><thead><tr><th>Local</th><th>Ciudad</th><th>Tipo</th><th>Descripci√≥n</th><th>Criticidad</th><th>Responsable</th><th>Fecha L√≠mite</th><th>Estado</th></tr></thead><tbody>${tbody}</tbody></table>`;
}
function renderVisitas() {
const filterV = document.getElementById('filterVisita').value.toLowerCase();
const filterCV = document.getElementById('filterCiudadV').value;
const filtered = visits.filter(v => {
if (filterCV && v.ciudad !== filterCV) return false;
if (filterV && !v.nombre?.toLowerCase().includes(filterV) && !v.codigo?.toLowerCase().includes(filterV) && !v.lider?.toLowerCase().includes(filterV)) return false;
return true;
}).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
document.getElementById('visitasBadge').textContent = filtered.length + ' visitas';
if (!filtered.length) {
document.getElementById('visitasTable').innerHTML = `<div class="empty"><div class="empty-icon">üè™</div><h3>Sin visitas</h3><p>No hay visitas con los filtros seleccionados</p></div>`;
return;
}
const tbody = filtered.map(v => {
const altas = (v.incidencias || []).filter(i => i.criticidad === 'Alta').length;
const cal = v.gen_calificacion?.split(' ')[0] || '‚Äî';
const fechaV = v.fecha_visita ? new Date(v.fecha_visita + 'T00:00:00').toLocaleDateString('es-CO', { day:'2-digit', month:'short', year:'2-digit'}) : '‚Äî';
return `<tr onclick="showVisitDetail('${v.id}')" style="cursor:pointer"><td><strong>${v.codigo || '‚Äî'}</strong></td><td>${v.nombre || '‚Äî'}<br><span style="font-size:0.76rem;color:var(--text-muted)">${v.lider || ''}</span></td><td>${v.ciudad || '‚Äî'}</td><td>${fechaV}</td><td><span class="cal-stars">${cal}</span></td><td>${v.num_incidencias || 0} ${altas > 0 ? `<span style="color:var(--danger);font-size:0.75rem;font-weight:600">(${altas} alta${altas>1?'s':''})</span>` : ''}</td><td style="font-size:0.78rem;color:var(--text-muted)">${v.auditor || '‚Äî'}</td><td><button class="btn-pdf" onclick="event.stopPropagation();showVisitDetail('${v.id}')">Ver</button></td></tr>`;
}).join('');
document.getElementById('visitasTable').innerHTML = `
<table><thead><tr><th>C√≥digo</th><th>Local / L√≠der</th><th>Ciudad</th><th>Fecha Visita</th><th>Calificaci√≥n</th><th>Incidencias</th><th>Auditor</th><th></th></tr></thead><tbody>${tbody}</tbody></table>`;
}
function showVisitDetail(id) {
const v = visits.find(x => x.id === id);
if (!v) return;
document.getElementById('modalTitle').textContent = `${v.codigo} ‚Äî ${v.nombre}`;
const fechaV = v.fecha_visita ? new Date(v.fecha_visita + 'T00:00:00').toLocaleDateString('es-CO', { weekday:'long', day:'2-digit', month:'long', year:'numeric'}) : '‚Äî';
const incsHtml = (v.incidencias || []).map((inc, i) => {
const crit = inc.criticidad?.toLowerCase() || '';
const estado = (inc.estado || '').toLowerCase().replace(' ', '-');
const fd = inc.fecha_seguimiento ? new Date(inc.fecha_seguimiento + 'T00:00:00').toLocaleDateString('es-CO', {day:'2-digit',month:'short',year:'2-digit'}) : '‚Äî';
return `<div class="inc-detail"><div class="inc-detail-head"><strong>#${i+1} ${inc.tipo || 'Incidencia'}</strong><div style="display:flex;gap:6px"><span class="badge-crit badge-${crit}">${inc.criticidad || '‚Äî'}</span><span class="badge-estado estado-${estado}">${inc.estado || '‚Äî'}</span></div></div><p style="font-size:0.85rem;margin-bottom:10px;color:var(--text)">${inc.descripcion || '‚Äî'}</p><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:0.78rem;color:var(--text-muted)"><span><strong>Responsable:</strong><br>${inc.responsable || '‚Äî'}</span><span><strong>√Årea:</strong><br>${inc.area || '‚Äî'}</span><span><strong>üìÖ Fecha l√≠mite:</strong><br><strong style="color:var(--text)">${fd}</strong></span></div></div>`;
}).join('') || '<p style="color:var(--text-muted);font-size:0.85rem">Sin incidencias registradas</p>';
document.getElementById('modalBody').innerHTML = `
<div class="modal-section"><h3>Identificaci√≥n</h3><div class="modal-grid"><div class="modal-field"><label>C√≥digo</label><p>${v.codigo || '‚Äî'}</p></div><div class="modal-field"><label>Ciudad</label><p>${v.ciudad || '‚Äî'}</p></div><div class="modal-field"><label>L√≠der</label><p>${v.lider || '‚Äî'}</p></div><div class="modal-field"><label>Fecha de visita</label><p>${fechaV}</p></div><div class="modal-field"><label>Auditor</label><p>${v.auditor || '‚Äî'}</p></div><div class="modal-field"><label>Calificaci√≥n general</label><p>${v.gen_calificacion || '‚Äî'}</p></div></div></div><div class="modal-section"><h3>Evaluaci√≥n</h3><div class="modal-grid"><div class="modal-field"><label>Sala ‚Äî Piso</label><p>${v.sala_piso || '‚Äî'}</p></div><div class="modal-field"><label>Sala ‚Äî Limpieza</label><p>${v.sala_limpieza || '‚Äî'}</p></div><div class="modal-field"><label>Bodega ‚Äî Organizaci√≥n</label><p>${v.bod_org || '‚Äî'}</p></div><div class="modal-field"><label>Bodega ‚Äî Inventario</label><p>${v.bod_inv || '‚Äî'}</p></div><div class="modal-field"><label>Comercial ‚Äî Metas</label><p>${v.com_metas || '‚Äî'}</p></div><div class="modal-field"><label>Infraestructura</label><p>${v.gen_infra || '‚Äî'}</p></div></div></div><div class="modal-section"><h3>Incidencias (${(v.incidencias||[]).length})</h3>
${incsHtml}
</div>
${v.compromisos ? `<div class="modal-section"><h3>Compromisos Pactados</h3><p style="font-size:0.88rem;line-height:1.6">${v.compromisos}</p></div>` : ''}
<div style="display:flex;gap:10px;justify-content:flex-end"><button class="btn-pdf" onclick="printVisit('${v.id}')">üñ® Imprimir reporte</button><button class="btn-pdf" style="background:var(--accent2)" onclick="closeModal()">Cerrar</button></div>`;
document.getElementById('detailModal').classList.remove('hidden');
}
function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
function printVisit(id) {
closeModal();
setTimeout(() => window.print(), 200);
}
function exportCSV() {
const headers = ['ID','Timestamp','Auditor','Codigo','Local','Ciudad','Lider','Fecha Visita','Calificacion','Num Incidencias','Incidencias Alta','Compromisos','Proxima Visita'];
const rows = visits.map(v => [
v.id, v.timestamp, v.auditor, v.codigo, v.nombre, v.ciudad, v.lider,
v.fecha_visita, v.gen_calificacion, v.num_incidencias, v.incidencias_alta,
`"${(v.compromisos || '').replace(/"/g, '""')}"`, v.proxima_visita
]);
const incHeaders = ['Visit_ID','Local','Ciudad','Inc_Tipo','Inc_Descripcion','Inc_Criticidad','Inc_Responsable','Inc_Area','Inc_FechaLimite','Inc_Estado'];
const incRows = [];
visits.forEach(v => {
(v.incidencias || []).forEach(inc => {
incRows.push([v.id, v.nombre, v.ciudad, inc.tipo, `"${(inc.descripcion||'').replace(/"/g,'""')}"`, inc.criticidad, inc.responsable, inc.area, inc.fecha_seguimiento, inc.estado]);
});
});
const csvVisits = [headers, ...rows].map(r => r.join(',')).join('\n');
const csvInc = [incHeaders, ...incRows].map(r => r.join(',')).join('\n');
const full = '=== VISITAS ===\n' + csvVisits + '\n\n=== INCIDENCIAS ===\n' + csvInc;
const blob = new Blob([full], { type: 'text/csv;charset=utf-8;' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a'); a.href = url;
a.download = `visitas_locales_${new Date().toISOString().split('T')[0]}.csv`;
a.click();
URL.revokeObjectURL(url);
showToast('‚úì CSV descargado');
}
function showToast(msg) {
const t = document.getElementById('toast');
t.textContent = msg; t.classList.add('show');
setTimeout(() => t.classList.remove('show'), 3000);
}
loadData();
document.getElementById('detailModal').addEventListener('click', function(e) {
if (e.target === this) closeModal();
});
setInterval(loadData, 5 * 60 * 1000);</script><div style="text-align:center;padding:20px;font-size:0.75rem;color:#7a9a7a;border-top:1px solid #c2ddc2;margin-top:20px;">
  ¬© Cruz Verde ‚Äî Sistema de Auditor√≠a de Locales
</div></body></html>async function submitForm(e) {
e.preventDefault();
const data = collectData();
const btn = document.getElementById('btnSubmit');
data.id = Date.now().toString();
const visits = JSON.parse(localStorage.getItem('vl_visits') || '[]');
visits.push(data);
localStorage.setItem('vl_visits', JSON.stringify(visits));
btn.disabled = true;
btn.querySelector('span').textContent = '‚è≥ Guardando...';
try {
await gsSend({...data, type: 'visita'});
for (const inc of (data.incidencias || [])) {
await gsSend({
type: 'incidencia',
visita_id: data.id,
codigo: data.codigo,
nombre: data.nombre,
ciudad: data.ciudad,
tipo: inc.tipo,
descripcion: inc.descripcion,
criticidad: inc.criticidad,
responsable: inc.responsable,
area: inc.area,
fecha_seguimiento: inc.fecha_seguimiento,
estado: inc.estado || 'Pendiente'
});
}
showToast('‚úÖ Visita guardada correctamente en Google Sheets');
resetForm();
} catch (err) {
console.error(err);
showToast('‚ö† ' + err.message, 'error');
btn.disabled = false;
btn.querySelector('span').textContent = 'üì§ Guardar Visita';
}
}
async function gsSend(payload) {
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwTDaRZIQLST72kYHEoQvwiHclL3L_lGDbzUZH3YGBwSjxP3l7fZw81CMABHlQBaR6K/exec';
const params = new URLSearchParams({data: JSON.stringify(payload)});
const r = await fetch(SCRIPT_URL + '?' + params);
if (!r.ok) throw new Error('Error al guardar (' + r.status + ')');
const json = await r.json();
if (json.status === 'error') throw new Error(json.message);
return json;
}
